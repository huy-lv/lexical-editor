"use strict";const B=require("./LexicalCollaborationContext.prod-D-ElPwCy.cjs"),a=require("./index-DckIzJDp.cjs"),n=require("react"),Y=require("@lexical/utils"),o=require("lexical"),F=require("react-dom"),q=require("yjs");function U(t){const s=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(t){for(const e in t)if(e!=="default"){const f=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(s,e,f.get?f:{enumerable:!0,get:()=>t[e]})}}return s.default=t,Object.freeze(s)}const $=U(n);function H(t,s,e,f,c,A,x,i,y,M,b,C,p=a.ke){const u=n.useRef(!1),D=n.useCallback(()=>e.connect(),[e]),m=n.useCallback(()=>{try{e.disconnect()}catch{}},[e]);n.useEffect(()=>{const{root:r}=i,{awareness:S}=e,E=({status:R})=>{t.dispatchCommand(a.we,R==="connected")},N=R=>{x&&R&&r.isEmpty()&&r._xmlText._length===0&&u.current===!1&&function(d,l){d.update(()=>{const I=o.$getRoot();if(I.isEmpty())if(l)switch(typeof l){case"string":{const O=d.parseEditorState(l);d.setEditorState(O,{tag:o.HISTORY_MERGE_TAG});break}case"object":d.setEditorState(l,{tag:o.HISTORY_MERGE_TAG});break;case"function":d.update(()=>{o.$getRoot().isEmpty()&&l(d)},{tag:o.HISTORY_MERGE_TAG})}else{const O=o.$createParagraphNode();I.append(O);const{activeElement:T}=document;(o.$getSelection()!==null||T!==null&&T===d.getRootElement())&&O.select()}},{tag:o.HISTORY_MERGE_TAG})}(t,b),u.current=!1},j=()=>{p(i,e)},k=(R,d)=>{const l=d.origin;l!==i&&a.Ne(i,e,R,l instanceof q.UndoManager,p)};a.Pe(e,c,A,document.activeElement===t.getRootElement(),C||{});const _=R=>{(function(d,l){if(d.update(()=>{const h=o.$getRoot();h.clear(),h.select()},{tag:o.SKIP_COLLAB_TAG}),l.cursors==null)return;const I=l.cursors;if(I==null)return;const O=l.cursorsContainer;if(O==null)return;const T=Array.from(I.values());for(let h=0;h<T.length;h++){const v=T[h].selection;if(v&&v.selections!=null){const G=v.selections;for(let L=0;L<G.length;L++)O.removeChild(G[h])}}})(t,i),y(R),f.set(s,R),u.current=!0};e.on("reload",_),e.on("status",E),e.on("sync",N),S.on("update",j),r.getSharedType().observeDeep(k);const w=t.registerUpdateListener(({prevEditorState:R,editorState:d,dirtyLeaves:l,dirtyElements:I,normalizedNodes:O,tags:T})=>{T.has(o.SKIP_COLLAB_TAG)===!1&&a.ve(i,e,R,d,I,l,O,T)}),P=D();return()=>{u.current===!1&&(P?P.then(m):m()),e.off("sync",N),e.off("status",E),e.off("reload",_),S.off("update",j),r.getSharedType().unobserveDeep(k),f.delete(s),w()}},[i,A,D,m,f,t,s,b,c,e,x,C,y,p]);const g=n.useMemo(()=>F.createPortal(a.jsxRuntimeExports.jsx("div",{ref:r=>{i.cursorsContainer=r}}),M&&M.current||document.body),[i,M]);return n.useEffect(()=>t.registerCommand(a.Se,r=>(r?(console.log("Collaboration connected!"),D()):(console.log("Collaboration disconnected!"),m()),!0),o.COMMAND_PRIORITY_EDITOR),[D,m,t]),g}function z(t,s){const e=n.useMemo(()=>a.Te(s,s.root.getSharedType()),[s]);n.useEffect(()=>Y.mergeRegister(t.registerCommand(o.UNDO_COMMAND,()=>(e.undo(),!0),o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.REDO_COMMAND,()=>(e.redo(),!0),o.COMMAND_PRIORITY_EDITOR)));const f=n.useCallback(()=>{e.clear()},[e]);return $.useEffect(()=>{const c=()=>{t.dispatchCommand(o.CAN_UNDO_COMMAND,e.undoStack.length>0),t.dispatchCommand(o.CAN_REDO_COMMAND,e.redoStack.length>0)};return e.on("stack-item-added",c),e.on("stack-item-popped",c),e.on("stack-cleared",c),()=>{e.off("stack-item-added",c),e.off("stack-item-popped",c),e.off("stack-cleared",c)}},[t,e]),f}function K({id:t,providerFactory:s,shouldBootstrap:e,username:f,cursorColor:c,cursorsContainerRef:A,initialEditorState:x,excludedProperties:i,awarenessData:y,syncCursorPositionsFn:M}){const b=n.useRef(!1),C=n.useRef(!1),p=B.l(f,c),{yjsDocMap:u,name:D,color:m}=p,[g]=a.o();n.useEffect(()=>(p.isCollabActive=!0,()=>{g._parentEditor==null&&(p.isCollabActive=!1)}),[p,g]);const[r,S]=n.useState(),[E,N]=n.useState();n.useEffect(()=>{if(C.current)return;C.current=!0;const _=s(t,u);return S(_),N(u.get(t)),()=>{_.disconnect()}},[t,s,u]);const[j,k]=n.useState();return n.useEffect(()=>{if(!r||b.current)return;b.current=!0;const _=a.le(g,r,t,E||u.get(t),u,i);return k(_),()=>{_.root.destroy(_)}},[g,r,t,u,E,i]),r&&j?a.jsxRuntimeExports.jsx(J,{awarenessData:y,binding:j,collabContext:p,color:m,cursorsContainerRef:A,editor:g,id:t,initialEditorState:x,name:D,provider:r,setDoc:N,shouldBootstrap:e,yjsDocMap:u,syncCursorPositionsFn:M}):a.jsxRuntimeExports.jsx(a.jsxRuntimeExports.Fragment,{})}function J({editor:t,id:s,provider:e,yjsDocMap:f,name:c,color:A,shouldBootstrap:x,cursorsContainerRef:i,initialEditorState:y,awarenessData:M,collabContext:b,binding:C,setDoc:p,syncCursorPositionsFn:u}){const D=H(t,s,e,f,c,A,x,C,p,i,y,M,u);return b.clientID=C.clientID,z(t,C),function(m,g,r,S,E){n.useEffect(()=>Y.mergeRegister(m.registerCommand(o.FOCUS_COMMAND,()=>(a.Fe(g,r,S,!0,E||{}),!1),o.COMMAND_PRIORITY_EDITOR),m.registerCommand(o.BLUR_COMMAND,()=>(a.Fe(g,r,S,!1,E||{}),!1),o.COMMAND_PRIORITY_EDITOR)),[S,m,r,g,E])}(t,e,c,A,M),D}exports._=K;
