"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const t=require("./index-DjceHJ_I.cjs"),A=require("@lexical/utils"),b=require("lexical"),i=require("react"),O=require("@excalidraw/excalidraw"),L=require("react-dom"),I=require("./ImageResizer-DmPsgehn.cjs");function S({closeOnClickOutside:n=!1,onSave:l,initialElements:f,initialAppState:g,initialFiles:o,isShown:m=!1,onDelete:a,onClose:u}){const c=i.useRef(null),[E,w]=i.useState(null),[r,M]=i.useState(!1),[h,C]=i.useState(f),[N,k]=i.useState(o);i.useEffect(()=>{var e;(e=c.current)==null||e.focus()},[]),i.useEffect(()=>{var j;let e=null;const d=p=>{const s=p.target;c.current!==null&&b.isDOMNode(s)&&!c.current.contains(s)&&n&&a()};return c.current!==null&&(e=(j=c.current)==null?void 0:j.parentElement,e==null||e.addEventListener("click",d)),()=>{e==null||e.removeEventListener("click",d)}},[n,a]),i.useLayoutEffect(()=>{const e=c.current,d=j=>{j.key==="Escape"&&a()};return e==null||e.addEventListener("keydown",d),()=>{e==null||e.removeEventListener("keydown",d)}},[h,N,a]);const v=()=>{if(h!=null&&h.some(e=>!e.isDeleted)){const e=E==null?void 0:E.getAppState(),d={exportBackground:e==null?void 0:e.exportBackground,exportScale:e==null?void 0:e.exportScale,exportWithDarkMode:(e==null?void 0:e.theme)==="dark",isBindingEnabled:e==null?void 0:e.isBindingEnabled,isLoading:e==null?void 0:e.isLoading,name:e==null?void 0:e.name,theme:e==null?void 0:e.theme,viewBackgroundColor:e==null?void 0:e.viewBackgroundColor,viewModeEnabled:e==null?void 0:e.viewModeEnabled,zenModeEnabled:e==null?void 0:e.zenModeEnabled,zoom:e==null?void 0:e.zoom};l(h,d,N)}else a()},y=()=>{M(!0)};function D(){return t.jsxRuntimeExports.jsxs(t.Modal,{title:"Discard",onClose:()=>{M(!1)},closeOnClickOutside:!1,children:["Are you sure you want to discard the changes?",t.jsxRuntimeExports.jsxs("div",{className:"ExcalidrawModal__discardModal",children:[t.jsxRuntimeExports.jsx(t.Button,{onClick:()=>{M(!1),u()},children:"Discard"})," ",t.jsxRuntimeExports.jsx(t.Button,{onClick:()=>{M(!1)},children:"Cancel"})]})]})}if(m===!1)return null;const _=(e,d,j)=>{C(e),k(j)};return L.createPortal(t.jsxRuntimeExports.jsx("div",{className:"ExcalidrawModal__overlay",role:"dialog",children:t.jsxRuntimeExports.jsx("div",{className:"ExcalidrawModal__modal",ref:c,tabIndex:-1,children:t.jsxRuntimeExports.jsxs("div",{className:"ExcalidrawModal__row",children:[r&&t.jsxRuntimeExports.jsx(D,{}),t.jsxRuntimeExports.jsx(O.Excalidraw,{onChange:_,excalidrawAPI:w,initialData:{appState:g||{isLoading:!1},elements:f,files:o}}),t.jsxRuntimeExports.jsxs("div",{className:"ExcalidrawModal__actions",children:[t.jsxRuntimeExports.jsx("button",{className:"action-button",onClick:y,children:"Discard"}),t.jsxRuntimeExports.jsx("button",{className:"action-button",onClick:v,children:"Save"})]})]})})}),document.body)}const z=n=>{var g;const l=(g=n==null?void 0:n.firstElementChild)==null?void 0:g.firstElementChild,f=n.getAttribute("viewBox");if(f!=null){const o=f.split(" ");n.setAttribute("width",o[2]),n.setAttribute("height",o[3])}l&&l.tagName==="style"&&l.remove()};function $({elements:n,files:l,imageContainerRef:f,appState:g,rootClassName:o=null,width:m="inherit",height:a="inherit"}){const[u,c]=i.useState(null);i.useEffect(()=>{(async()=>{const r=await O.exportToSvg({appState:g,elements:n,files:l});z(r),r.setAttribute("width","100%"),r.setAttribute("height","100%"),r.setAttribute("display","block"),c(r)})()},[n,l,g]);const E={};return m!=="inherit"&&(E.width=`${m}px`),a!=="inherit"&&(E.height=`${a}px`),t.jsxRuntimeExports.jsx("div",{ref:w=>{w&&f&&(f.current=w)},className:o??"",style:E,dangerouslySetInnerHTML:{__html:(u==null?void 0:u.outerHTML)??""}})}function T({nodeKey:n,data:l,width:f,height:g}){const[o]=t.o(),m=t.a(),[a,u]=i.useState(l==="[]"&&o.isEditable()),c=i.useRef(null),E=i.useRef(null),w=i.useRef(null),[r,M,h]=t.u(n),[C,N]=i.useState(!1);i.useEffect(()=>{if(!m){r&&h();return}return A.mergeRegister(o.registerCommand(b.CLICK_COMMAND,s=>{const R=E.current,x=s.target;return C?!0:R!==null&&b.isDOMNode(x)&&R.contains(x)?(s.shiftKey||h(),M(!r),s.detail>1&&u(!0),!0):!1},b.COMMAND_PRIORITY_LOW))},[h,o,r,C,M,m]);const k=i.useCallback(()=>(u(!1),o.update(()=>{const s=b.$getNodeByKey(n);s&&s.remove()})),[o,n]),v=(s,R,x)=>o.update(()=>{const B=b.$getNodeByKey(n);t.$isExcalidrawNode(B)&&(s&&s.length>0||Object.keys(x).length>0?B.setData(JSON.stringify({appState:R,elements:s,files:x})):B.remove())}),y=()=>{N(!0)},D=(s,R)=>{setTimeout(()=>{N(!1)},200),o.update(()=>{const x=b.$getNodeByKey(n);t.$isExcalidrawNode(x)&&(x.setWidth(s),x.setHeight(R))})},_=i.useCallback(()=>{u(!0)},[]),{elements:e=[],files:d={},appState:j={}}=i.useMemo(()=>JSON.parse(l),[l]),p=i.useCallback(()=>{u(!1),e.length===0&&o.update(()=>{const s=b.$getNodeByKey(n);s&&s.remove()})},[o,n,e.length]);return t.jsxRuntimeExports.jsxs(t.jsxRuntimeExports.Fragment,{children:[m&&a&&t.jsxRuntimeExports.jsx(S,{initialElements:e,initialFiles:d,initialAppState:j,isShown:a,onDelete:k,onClose:p,onSave:(s,R,x)=>{v(s,R,x),u(!1)},closeOnClickOutside:!1}),e.length>0&&t.jsxRuntimeExports.jsxs("button",{ref:E,className:`excalidraw-button ${r?"selected":""}`,children:[t.jsxRuntimeExports.jsx($,{imageContainerRef:c,className:"image",elements:e,files:d,appState:j,width:f,height:g}),r&&m&&t.jsxRuntimeExports.jsx("div",{className:"image-edit-button",role:"button",tabIndex:0,onMouseDown:s=>s.preventDefault(),onClick:_}),(r||C)&&m&&t.jsxRuntimeExports.jsx(I.ImageResizer,{buttonRef:w,showCaption:!0,setShowCaption:()=>null,imageRef:c,editor:o,onResizeStart:y,onResizeEnd:D,captionsEnabled:!0})]})]})}exports.default=T;
